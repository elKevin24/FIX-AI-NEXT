generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  TECHNICIAN
  RECEPTIONIST
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_FOR_PARTS
  RESOLVED
  CLOSED
  CANCELLED
}

enum ServiceCategory {
  MAINTENANCE
  REPAIR
  UPGRADE
  DIAGNOSTIC
  INSTALLATION
  CONSULTATION
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TechnicianStatus {
  AVAILABLE
  UNAVAILABLE
  ON_VACATION
  ON_LEAVE
  IN_TRAINING
  SICK_LEAVE
}

enum Specialization {
  LAPTOPS
  DESKTOPS
  PRINTERS
  NETWORKING
  MOBILE_DEVICES
  SERVERS
  PERIPHERALS
  SOFTWARE
  GENERAL
}

model Tenant {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users            User[]
  tickets          Ticket[]
  customers        Customer[]
  parts            Part[]
  auditLogs        AuditLog[]
  serviceTemplates ServiceTemplate[]

  @@map("tenants")
}

model User {
  id       String   @id @default(uuid())
  email    String   @unique
  password String
  name     String?
  role     UserRole @default(TECHNICIAN)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  // Configuraci√≥n del t√©cnico
  status               TechnicianStatus @default(AVAILABLE)
  maxConcurrentTickets Int              @default(5) // L√≠mite de tickets simult√°neos
  statusReason         String? // Raz√≥n de unavailable/leave
  availableFrom        DateTime? // Fecha de regreso si est√° ausente
  availableUntil       DateTime? // Fecha fin de ausencia

  assignedTickets  Ticket[]
  auditLogs        AuditLog[]
  ticketNotes      TicketNote[]
  createdTickets   Ticket[]                   @relation("TicketCreatedBy")
  updatedTickets   Ticket[]                   @relation("TicketUpdatedBy")
  createdCustomers Customer[]                 @relation("CustomerCreatedBy")
  updatedCustomers Customer[]                 @relation("CustomerUpdatedBy")
  createdParts     Part[]                     @relation("PartCreatedBy")
  updatedParts     Part[]                     @relation("PartUpdatedBy")
  createdTemplates ServiceTemplate[]          @relation("TemplateCreatedBy")
  updatedTemplates ServiceTemplate[]          @relation("TemplateUpdatedBy")
  specializations  TechnicianSpecialization[]
  unavailabilities TechnicianUnavailability[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model Customer {
  id      String  @id @default(uuid())
  name    String
  email   String?
  phone   String?
  address String?
  dpi     String?
  nit     String?

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  tickets Ticket[]

  createdById String?
  createdBy   User?   @relation("CustomerCreatedBy", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?   @relation("CustomerUpdatedBy", fields: [updatedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([createdById])
  @@index([updatedById])
  @@map("customers")
}

model Ticket {
  id                 String         @id @default(uuid())
  title              String
  description        String
  status             TicketStatus   @default(OPEN)
  priority           TicketPriority @default(MEDIUM)
  deviceType         String?        @default("PC")
  deviceModel        String?
  serialNumber       String?
  accessories        String?
  checkInNotes       String?
  cancellationReason String?

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  assignedToId String?
  assignedTo   User?   @relation(fields: [assignedToId], references: [id])

  serviceTemplateId String?
  serviceTemplate   ServiceTemplate? @relation(fields: [serviceTemplateId], references: [id])

  partsUsed PartUsage[]
  notes     TicketNote[]

  createdById String?
  createdBy   User?   @relation("TicketCreatedBy", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?   @relation("TicketUpdatedBy", fields: [updatedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, priority]) // Para queries del pool
  @@index([assignedToId, status]) // Para workload por t√©cnico
  @@index([serviceTemplateId])
  @@index([createdById])
  @@index([updatedById])
  @@map("tickets")
}

model Part {
  id       String  @id @default(uuid())
  name     String
  sku      String?
  quantity Int     @default(0)
  cost     Decimal @db.Decimal(10, 2)
  price    Decimal @db.Decimal(10, 2)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  usages               PartUsage[]
  templateDefaultParts TemplateDefaultPart[]

  createdById String?
  createdBy   User?   @relation("PartCreatedBy", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?   @relation("PartUpdatedBy", fields: [updatedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([createdById])
  @@index([updatedById])
  @@map("parts")
}

model PartUsage {
  id       String @id @default(uuid())
  quantity Int

  ticketId String
  ticket   Ticket @relation(fields: [ticketId], references: [id])

  partId String
  part   Part   @relation(fields: [partId], references: [id])

  createdAt DateTime @default(now())

  @@map("part_usages")
}

model AuditLog {
  id      String  @id @default(uuid())
  action  String
  details String?

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  createdAt DateTime @default(now())

  @@map("audit_logs")
}

model TicketNote {
  id         String  @id @default(uuid())
  content    String
  isInternal Boolean @default(true)

  ticketId String
  ticket   Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  authorId String
  author   User   @relation(fields: [authorId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("ticket_notes")
}

model ServiceTemplate {
  id                 String          @id @default(uuid())
  name               String
  category           ServiceCategory
  defaultTitle       String
  defaultDescription String          @db.Text
  defaultPriority    String          @default("Medium")
  estimatedDuration  Int? // en minutos
  laborCost          Decimal?        @db.Decimal(10, 2)
  isActive           Boolean         @default(true)
  color              String?         @default("#3B82F6") // Color para UI
  icon               String?         @default("üîß") // Emoji o nombre de icono

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  defaultParts TemplateDefaultPart[]
  tickets      Ticket[]

  createdById String?
  createdBy   User?   @relation("TemplateCreatedBy", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?   @relation("TemplateUpdatedBy", fields: [updatedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, category])
  @@index([tenantId, isActive])
  @@index([createdById])
  @@index([updatedById])
  @@map("service_templates")
}

model TemplateDefaultPart {
  id       String  @id @default(uuid())
  quantity Int     @default(1)
  required Boolean @default(false) // Si es obligatorio o sugerido

  templateId String
  template   ServiceTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  partId String
  part   Part   @relation(fields: [partId], references: [id])

  createdAt DateTime @default(now())

  @@index([templateId])
  @@index([partId])
  @@map("template_default_parts")
}

// Especialidades del t√©cnico
model TechnicianSpecialization {
  id String @id @default(uuid())

  userId         String
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  specialization Specialization

  createdAt DateTime @default(now())

  @@unique([userId, specialization])
  @@index([userId])
  @@map("technician_specializations")
}

// Per√≠odos de indisponibilidad del t√©cnico
model TechnicianUnavailability {
  id     String           @id @default(uuid())
  reason TechnicianStatus @default(UNAVAILABLE)
  notes  String?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  startDate DateTime
  endDate   DateTime
  isActive  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([userId, isActive])
  @@index([startDate, endDate])
  @@map("technician_unavailabilities")
}
