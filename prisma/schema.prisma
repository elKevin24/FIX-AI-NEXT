generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  TECHNICIAN
  RECEPTIONIST
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_FOR_PARTS
  RESOLVED
  CLOSED
  CANCELLED
}

enum ServiceCategory {
  MAINTENANCE
  REPAIR
  UPGRADE
  DIAGNOSTIC
  INSTALLATION
  CONSULTATION
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TechnicianStatus {
  AVAILABLE
  UNAVAILABLE
  ON_VACATION
  ON_LEAVE
  IN_TRAINING
  SICK_LEAVE
}

enum Specialization {
  LAPTOPS
  DESKTOPS
  PRINTERS
  NETWORKING
  MOBILE_DEVICES
  SERVERS
  PERIPHERALS
  SOFTWARE
  GENERAL
}

model Tenant {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users            User[]
  tickets          Ticket[]
  customers        Customer[]
  parts            Part[]
  auditLogs        AuditLog[]
  serviceTemplates ServiceTemplate[]
  purchaseOrders   PurchaseOrder[]
  notifications    Notification[]
  invoices         Invoice[]
  payments         Payment[]
  cashRegisters    CashRegister[]
  cashTransactions CashTransaction[]

  @@map("tenants")
}

model User {
  id       String   @id @default(uuid())
  email    String   @unique
  password String
  name     String?
  role     UserRole @default(TECHNICIAN)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  // Configuraci贸n del t茅cnico
  status               TechnicianStatus @default(AVAILABLE)
  maxConcurrentTickets Int              @default(5) // L铆mite de tickets simult谩neos
  statusReason         String? // Raz贸n de unavailable/leave
  availableFrom        DateTime? // Fecha de regreso si est谩 ausente
  availableUntil       DateTime? // Fecha fin de ausencia

  assignedTickets     Ticket[]
  auditLogs           AuditLog[]
  ticketNotes         TicketNote[]
  createdTickets      Ticket[]                   @relation("TicketCreatedBy")
  updatedTickets      Ticket[]                   @relation("TicketUpdatedBy")
  createdCustomers    Customer[]                 @relation("CustomerCreatedBy")
  updatedCustomers    Customer[]                 @relation("CustomerUpdatedBy")
  createdParts        Part[]                     @relation("PartCreatedBy")
  updatedParts        Part[]                     @relation("PartUpdatedBy")
  createdTemplates    ServiceTemplate[]          @relation("TemplateCreatedBy")
  updatedTemplates    ServiceTemplate[]          @relation("TemplateUpdatedBy")
  specializations     TechnicianSpecialization[]
  unavailabilities    TechnicianUnavailability[]
  notifications       Notification[]
  createdInvoices     Invoice[]                  @relation("InvoiceCreatedBy")
  updatedInvoices     Invoice[]                  @relation("InvoiceUpdatedBy")
  receivedPayments    Payment[]
  openedCashRegisters CashRegister[]             @relation("CashRegisterOpenedBy")
  closedCashRegisters CashRegister[]             @relation("CashRegisterClosedBy")
  cashTransactions    CashTransaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model Customer {
  id      String  @id @default(uuid())
  name    String
  email   String?
  phone   String?
  address String?
  dpi     String?
  nit     String?

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  tickets  Ticket[]
  invoices Invoice[]

  createdById String?
  createdBy   User?   @relation("CustomerCreatedBy", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?   @relation("CustomerUpdatedBy", fields: [updatedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([dpi, tenantId], name: "unique_dpi_per_tenant")
  @@unique([nit, tenantId], name: "unique_nit_per_tenant")
  @@index([createdById])
  @@index([updatedById])
  @@index([tenantId])
  @@map("customers")
}

model Ticket {
  id                 String         @id @default(uuid())
  title              String
  description        String
  status             TicketStatus   @default(OPEN)
  priority           TicketPriority @default(MEDIUM)
  deviceType         String?        @default("PC")
  deviceModel        String?
  serialNumber       String?
  accessories        String?
  checkInNotes       String?
  cancellationReason String?

  estimatedCompletionDate DateTime? // Calculated based on services
  dueDate                 DateTime? // Promised delivery date (SLA)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  assignedToId String?
  assignedTo   User?   @relation(fields: [assignedToId], references: [id])

  serviceTemplateId String?
  serviceTemplate   ServiceTemplate? @relation(fields: [serviceTemplateId], references: [id])

  partsUsed PartUsage[]
  services  TicketService[]
  notes     TicketNote[]
  invoice   Invoice?

  createdById String?
  createdBy   User?   @relation("TicketCreatedBy", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?   @relation("TicketUpdatedBy", fields: [updatedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, priority]) // Para queries del pool
  @@index([assignedToId, status]) // Para workload por t茅cnico
  @@index([serviceTemplateId])
  @@index([createdById])
  @@index([updatedById])
  @@map("tickets")
}

model Part {
  id       String  @id @default(uuid())
  name     String
  sku      String?
  quantity Int     @default(0)
  cost     Decimal @db.Decimal(10, 2)
  price    Decimal @db.Decimal(10, 2)
  category String? // 'SCREEN', 'KEYBOARD', etc.
  location String? // 'Estante A1'
  minStock Int     @default(1) // Alerta cuando quantity <= minStock

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  usages               PartUsage[]
  templateDefaultParts TemplateDefaultPart[]
  purchaseItems        PurchaseItem[]

  createdById String?
  createdBy   User?   @relation("PartCreatedBy", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?   @relation("PartUpdatedBy", fields: [updatedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sku, tenantId], name: "unique_sku_per_tenant")
  @@index([createdById])
  @@index([updatedById])
  @@index([tenantId])
  @@map("parts")
}

model PurchaseOrder {
  id           String         @id @default(uuid())
  supplier     String // 'Intelaf', 'Amazon', etc.
  status       PurchaseStatus @default(PENDING) // PENDING, RECEIVED, CANCELLED
  orderDate    DateTime       @default(now())
  receivedDate DateTime?
  totalCost    Decimal        @default(0) @db.Decimal(10, 2)

  items PurchaseItem[]

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  createdById String?
  updatedById String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@map("purchase_orders")
}

model PurchaseItem {
  id       String  @id @default(uuid())
  quantity Int
  unitCost Decimal @db.Decimal(10, 2)

  partId String
  part   Part   @relation(fields: [partId], references: [id])

  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])

  @@map("purchase_items")
}

enum PurchaseStatus {
  PENDING
  RECEIVED
  CANCELLED
}

model PartUsage {
  id       String @id @default(uuid())
  quantity Int

  ticketId String
  ticket   Ticket @relation(fields: [ticketId], references: [id])

  partId String
  part   Part   @relation(fields: [partId], references: [id])

  createdAt DateTime @default(now())

  @@map("part_usages")
}

model AuditLog {
  id      String  @id @default(uuid())
  action  String
  details String?

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@map("audit_logs")
}

model TicketNote {
  id         String  @id @default(uuid())
  content    String
  isInternal Boolean @default(true)

  ticketId String
  ticket   Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  authorId String
  author   User   @relation(fields: [authorId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("ticket_notes")
}

model ServiceTemplate {
  id                 String          @id @default(uuid())
  name               String
  category           ServiceCategory
  defaultTitle       String
  defaultDescription String          @db.Text
  defaultPriority    String          @default("Medium")
  estimatedDuration  Int? // en minutos
  laborCost          Decimal?        @db.Decimal(10, 2)
  isActive           Boolean         @default(true)
  color              String?         @default("#3B82F6") // Color para UI
  icon               String?         @default("") // Emoji o nombre de icono

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  defaultParts TemplateDefaultPart[]
  tickets      Ticket[]
  usages       TicketService[]

  createdById String?
  createdBy   User?   @relation("TemplateCreatedBy", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?   @relation("TemplateUpdatedBy", fields: [updatedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, category])
  @@index([tenantId, isActive])
  @@index([createdById])
  @@index([updatedById])
  @@map("service_templates")
}

model TemplateDefaultPart {
  id       String  @id @default(uuid())
  quantity Int     @default(1)
  required Boolean @default(false) // Si es obligatorio o sugerido

  templateId String
  template   ServiceTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  partId String
  part   Part   @relation(fields: [partId], references: [id])

  createdAt DateTime @default(now())

  @@index([templateId])
  @@index([partId])
  @@map("template_default_parts")
}

model TicketService {
  id String @id @default(uuid())

  ticketId String
  ticket   Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  serviceId String
  service   ServiceTemplate @relation(fields: [serviceId], references: [id])

  // Snapshot of values at time of addition
  name      String
  laborCost Decimal @db.Decimal(10, 2)

  createdAt DateTime @default(now())

  @@index([ticketId])
  @@index([serviceId])
  @@map("ticket_services")
}

// Especialidades del t茅cnico
model TechnicianSpecialization {
  id String @id @default(uuid())

  userId         String
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  specialization Specialization

  createdAt DateTime @default(now())

  @@unique([userId, specialization])
  @@index([userId])
  @@map("technician_specializations")
}

// Per铆odos de indisponibilidad del t茅cnico
model TechnicianUnavailability {
  id     String           @id @default(uuid())
  reason TechnicianStatus @default(UNAVAILABLE)
  notes  String?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  startDate DateTime
  endDate   DateTime
  isActive  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([userId, isActive])
  @@index([startDate, endDate])
  @@map("technician_unavailabilities")
}

model Notification {
  id      String  @id @default(uuid())
  userId  String
  user    User    @relation(fields: [userId], references: [id])
  type    String // 'INFO', 'WARNING', 'SUCCESS', 'ERROR'
  title   String
  message String
  link    String? // URL to redirect to
  isRead  Boolean @default(false)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([tenantId])
  @@map("notifications")
}

// ============================================================================
// BILLING & FINANCE MODELS
// ============================================================================

enum PaymentMethod {
  CASH // Efectivo
  CARD // Tarjeta (d茅bito/cr茅dito)
  TRANSFER // Transferencia bancaria
  CHECK // Cheque
  OTHER // Otro
}

enum InvoiceStatus {
  DRAFT // Borrador
  PENDING // Pendiente de pago
  PAID // Pagada
  CANCELLED // Cancelada
  OVERDUE // Vencida
}

// Factura/Recibo generado para un ticket cerrado
model Invoice {
  id            String        @id @default(uuid())
  invoiceNumber String // Numeraci贸n secuencial: INV-0001, INV-0002, etc.
  status        InvoiceStatus @default(PENDING)

  // Relaci贸n con ticket
  ticketId String @unique
  ticket   Ticket @relation(fields: [ticketId], references: [id])

  // Relaci贸n con cliente
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])

  // Desglose financiero
  laborCost      Decimal @default(0) @db.Decimal(10, 2) // Mano de obra
  partsCost      Decimal @default(0) @db.Decimal(10, 2) // Costo de repuestos
  partsMarkup    Decimal @default(0) @db.Decimal(10, 2) // Ganancia en repuestos
  subtotal       Decimal @default(0) @db.Decimal(10, 2) // Subtotal antes de impuestos
  taxRate        Decimal @default(0) @db.Decimal(5, 2) // Tasa de IVA (ej: 12.00 para 12%)
  taxAmount      Decimal @default(0) @db.Decimal(10, 2) // Monto de IVA
  discountAmount Decimal @default(0) @db.Decimal(10, 2) // Descuento aplicado
  total          Decimal @default(0) @db.Decimal(10, 2) // Total a pagar

  // Informaci贸n fiscal (Guatemala)
  customerName    String
  customerNIT     String? // NIT del cliente (factura fiscal)
  customerDPI     String? // DPI del cliente
  customerAddress String?

  // Notas y t茅rminos
  notes        String? @db.Text
  paymentTerms String? // Ej: "Pago al retirar equipo"

  // Fechas
  issuedAt DateTime  @default(now()) // Fecha de emisi贸n
  dueAt    DateTime? // Fecha de vencimiento
  paidAt   DateTime? // Fecha de pago

  // Multi-tenancy
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  // Auditor铆a
  createdById String
  createdBy   User   @relation("InvoiceCreatedBy", fields: [createdById], references: [id])
  updatedById String
  updatedBy   User   @relation("InvoiceUpdatedBy", fields: [updatedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaci贸n con pagos
  payments Payment[]

  @@unique([invoiceNumber, tenantId], name: "unique_invoice_number_per_tenant")
  @@index([tenantId])
  @@index([customerId])
  @@index([ticketId])
  @@index([status])
  @@index([issuedAt])
  @@map("invoices")
}

// Registro de pagos recibidos
model Payment {
  id            String @id @default(uuid())
  paymentNumber String // Numeraci贸n: PAY-0001, PAY-0002, etc.

  // Relaci贸n con factura
  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id])

  // Detalles del pago
  amount         Decimal       @db.Decimal(10, 2) // Monto pagado
  paymentMethod  PaymentMethod
  transactionRef String? // Referencia de transacci贸n (n煤mero de cheque, referencia bancaria)
  notes          String?       @db.Text

  // Fecha
  paidAt DateTime @default(now())

  // Multi-tenancy
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  // Auditor铆a
  receivedById String
  receivedBy   User   @relation(fields: [receivedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([paymentNumber, tenantId], name: "unique_payment_number_per_tenant")
  @@index([tenantId])
  @@index([invoiceId])
  @@index([paidAt])
  @@map("payments")
}

// Caja registradora - Registro de apertura/cierre de caja
model CashRegister {
  id   String @id @default(uuid())
  name String // Ej: "Caja Principal", "Caja Sucursal 1"

  // Estado de la caja
  isOpen   Boolean   @default(false)
  openedAt DateTime?
  closedAt DateTime?

  // Montos
  openingBalance  Decimal @default(0) @db.Decimal(10, 2) // Saldo inicial
  closingBalance  Decimal @default(0) @db.Decimal(10, 2) // Saldo final
  expectedBalance Decimal @default(0) @db.Decimal(10, 2) // Saldo esperado (calculado)
  difference      Decimal @default(0) @db.Decimal(10, 2) // Diferencia (real - esperado)

  // Notas del cierre
  closingNotes String? @db.Text

  // Multi-tenancy
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  // Usuario que abri贸/cerr贸
  openedById String?
  openedBy   User?   @relation("CashRegisterOpenedBy", fields: [openedById], references: [id])
  closedById String?
  closedBy   User?   @relation("CashRegisterClosedBy", fields: [closedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaci贸n con transacciones de caja
  transactions CashTransaction[]

  @@index([tenantId])
  @@index([isOpen])
  @@index([openedAt])
  @@map("cash_registers")
}

// Transacciones de caja (movimientos de efectivo)
model CashTransaction {
  id          String  @id @default(uuid())
  type        String // 'INCOME' (ingreso), 'EXPENSE' (gasto), 'WITHDRAWAL' (retiro)
  amount      Decimal @db.Decimal(10, 2)
  description String
  reference   String? // Referencia a factura, ticket, etc.

  // Relaci贸n con caja
  cashRegisterId String
  cashRegister   CashRegister @relation(fields: [cashRegisterId], references: [id])

  // Multi-tenancy
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  // Auditor铆a
  createdById String
  createdBy   User   @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([cashRegisterId])
  @@index([createdAt])
  @@map("cash_transactions")
}
